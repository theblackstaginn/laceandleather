<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pay — Lace & Leather</title>
  <meta name="robots" content="noindex,nofollow" />
  <link rel="stylesheet" href="./styles.css" />
</head>

<body class="pay-page">
  <div class="bg" aria-hidden="true"></div>
  <div class="dust" aria-hidden="true">
    <span></span><span></span><span></span><span></span>
    <span></span><span></span><span></span><span></span>
    <span></span><span></span><span></span><span></span>
    <span></span><span></span><span></span><span></span>
  </div>

  <main class="wrap pay-wrap">
    <section class="glass pay-glass" aria-label="Payment screen">
      <header class="pay-top">
        <div class="pay-brand">
          <div class="brand">Lace &amp; Leather</div>
          <div class="muted pay-sub">Cart + QR checkout (PayPal)</div>
        </div>

        <div class="pay-actions">
          <button class="mini-btn" type="button" id="backBtn">Back</button>
          <button class="mini-btn" type="button" id="clearBtn">Clear cart</button>
        </div>
      </header>

      <section class="pay-grid">
        <!-- LEFT -->
        <div class="pay-panel" aria-label="Cart panel">
          <div class="pay-h">Cart</div>

          <div id="cart" class="pay-cart"></div>

          <div class="pay-sumrow">
            <div class="muted">Subtotal</div>
            <strong id="subtotal">$0.00</strong>
          </div>

          <div id="warn" class="pay-warn"></div>
        </div>

        <!-- RIGHT -->
        <div class="pay-panel" aria-label="Payment panel">
          <div class="pay-h">Scan to pay</div>

          <div class="pay-amount" id="amount">$0.00</div>

          <div class="pay-qrwrap">
            <img id="qr" class="pay-qr" alt="PayPal QR code" />
          </div>

          <div class="pay-row">
            <span class="muted">Order ID</span>
            <span class="pay-pill">
              <strong id="orderId">—</strong>
              <button class="mini-btn" type="button" id="copyOrder">Copy</button>
            </span>
          </div>

          <div class="muted pay-note">
            In PayPal, paste the Order ID into the note.
          </div>

          <div class="pay-ctas">
            <button class="pay-btn" type="button" id="openPaypal">Open PayPal on this device</button>
            <button class="mini-btn" type="button" id="paidBtn">I paid</button>
          </div>
        </div>
      </section>

      <footer class="pay-fine muted">
        This page replaces your cart modal: edit quantities here, then scan/pay. Designed for a tablet at the counter.
      </footer>
    </section>
  </main>

  <script>
    (() => {
      "use strict";

      // === CONFIG ===
      const PAYPAL_ME_HANDLE = "YOUR_PAYPAL_ME_HANDLE"; // <-- set this

      // Storage keys (MUST match your main site)
      const CART_KEY  = "ll_cart";
      const ORDER_KEY = "ll_order_id";

      const $ = (id) => document.getElementById(id);

      const cartEl = $("cart");
      const subtotalEl = $("subtotal");
      const amountEl = $("amount");
      const orderEl = $("orderId");
      const qrEl = $("qr");
      const warnEl = $("warn");

      let currentPayUrl = "";

      const money = (n) => {
        const x = Number(n || 0);
        return x.toLocaleString(undefined, { style:"currency", currency:"USD" });
      };

      const safeId = () =>
        Math.random().toString(16).slice(2, 6).toUpperCase() + "-" +
        Math.random().toString(16).slice(2, 6).toUpperCase();

      const setWarn = (msg) => {
        warnEl.textContent = msg;
        warnEl.style.display = msg ? "block" : "none";
      };

      const readCart = () => {
        try{
          const raw = localStorage.getItem(CART_KEY);
          const arr = raw ? JSON.parse(raw) : [];
          return Array.isArray(arr) ? arr : [];
        }catch{ return []; }
      };

      const writeCart = (cart) => {
        localStorage.setItem(CART_KEY, JSON.stringify(cart));
      };

      const subtotal = (cart) =>
        cart.reduce((sum, it) => {
          const price = Number(it && it.price) || 0;
          const qty = Math.max(1, Number(it && it.qty) || 1);
          return sum + price * qty;
        }, 0);

      const ensureOrderId = () => {
        let id = localStorage.getItem(ORDER_KEY);
        if (!id || id === "—") {
          id = safeId();
          localStorage.setItem(ORDER_KEY, id);
        }
        orderEl.textContent = id;
        return id;
      };

      const paypalUrlFor = (amount, orderId) => {
        const base = `https://paypal.me/${encodeURIComponent(PAYPAL_ME_HANDLE)}/${Number(amount).toFixed(2)}`;
        return `${base}?utm_source=laceleatherarcane&utm_medium=tabletpay&utm_campaign=${encodeURIComponent(orderId)}`;
      };

      const escapeHtml = (s) =>
        String(s).replace(/[&<>"']/g, (c) => ({
          "&":"&amp;", "<":"&lt;", ">":"&gt;", '"':"&quot;", "'":"&#39;"
        }[c]));

      const render = () => {
        const cart = readCart();
        const total = subtotal(cart);
        const oid = ensureOrderId();

        subtotalEl.textContent = money(total);
        amountEl.textContent = money(total);

        cartEl.innerHTML = "";

        if (!PAYPAL_ME_HANDLE || PAYPAL_ME_HANDLE === "YOUR_PAYPAL_ME_HANDLE") {
          setWarn("Set your PayPal.me handle in pay.html (PAYPAL_ME_HANDLE).");
        } else if (total <= 0) {
          setWarn("Cart is empty. Go back and add items.");
        } else {
          setWarn("");
        }

        if (!cart.length) {
          cartEl.innerHTML = `<div class="muted pay-empty">No items yet.</div>`;
        } else {
          cart.forEach((it, idx) => {
            const title = it && it.title ? String(it.title) : "Item";
            const price = Number(it && it.price) || 0;
            const qty = Math.max(1, Number(it && it.qty) || 1);

            const row = document.createElement("div");
            row.className = "pay-item";
            row.innerHTML = `
              <div class="pay-item-left">
                <div class="pay-item-title">${escapeHtml(title)}</div>
                <div class="muted pay-item-sub">${money(price)} each</div>
              </div>

              <div class="pay-item-right">
                <div class="pay-qty" aria-label="Quantity controls">
                  <button class="qty-btn" data-dec="${idx}" type="button" aria-label="Decrease quantity">−</button>
                  <div class="pay-qtynum" aria-label="Quantity">${qty}</div>
                  <button class="qty-btn" data-inc="${idx}" type="button" aria-label="Increase quantity">+</button>
                </div>
                <button class="remove-btn" data-rm="${idx}" type="button">Remove</button>
              </div>
            `;
            cartEl.appendChild(row);
          });
        }

        // QR + link
        if (PAYPAL_ME_HANDLE && PAYPAL_ME_HANDLE !== "YOUR_PAYPAL_ME_HANDLE" && total > 0) {
          currentPayUrl = paypalUrlFor(total, oid);
          const qrUrl =
            "https://api.qrserver.com/v1/create-qr-code/?size=520x520&margin=10&data=" +
            encodeURIComponent(currentPayUrl);
          qrEl.src = qrUrl;
        } else {
          currentPayUrl = "";
          qrEl.removeAttribute("src");
        }
      };

      document.addEventListener("click", (e) => {
        const cart = readCart();

        const inc = e.target.closest("[data-inc]");
        if (inc) {
          const i = Number(inc.getAttribute("data-inc"));
          if (cart[i]) cart[i].qty = Math.max(1, (Number(cart[i].qty)||1) + 1);
          writeCart(cart);
          render();
          return;
        }

        const dec = e.target.closest("[data-dec]");
        if (dec) {
          const i = Number(dec.getAttribute("data-dec"));
          if (cart[i]) cart[i].qty = Math.max(1, (Number(cart[i].qty)||1) - 1);
          writeCart(cart);
          render();
          return;
        }

        const rm = e.target.closest("[data-rm]");
        if (rm) {
          const i = Number(rm.getAttribute("data-rm"));
          cart.splice(i, 1);
          writeCart(cart);
          render();
          return;
        }
      });

      $("copyOrder").addEventListener("click", async () => {
        try {
          await navigator.clipboard.writeText(orderEl.textContent.trim());
          setWarn("Order ID copied.");
          setTimeout(() => setWarn(""), 1100);
        } catch {
          setWarn("Couldn't copy automatically. Tap and hold to copy the Order ID.");
        }
      });

      $("openPaypal").addEventListener("click", () => {
        if (!currentPayUrl) return;
        window.open(currentPayUrl, "_blank", "noopener,noreferrer");
      });

      $("paidBtn").addEventListener("click", () => {
        window.location.href = "./index.html";
      });

      $("clearBtn").addEventListener("click", () => {
        localStorage.removeItem(CART_KEY);
        localStorage.removeItem(ORDER_KEY);
        render();
      });

      $("backBtn").addEventListener("click", () => {
        window.location.href = "./index.html";
      });

      render();
    })();
  </script>
</body>
</html>