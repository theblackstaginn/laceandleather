<!doctype html>
<html lang="en" class="pay-html">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Lace &amp; Leather — Pay</title>

  <!-- IMPORTANT: bump this whenever you edit CSS -->
  <link rel="stylesheet" href="./styles.css?v=PAY-007" />
</head>

<body class="pay-page">
  <div class="bg" aria-hidden="true"></div>

  <main class="pay-shell" aria-label="Checkout">
    <section class="tablet-wrap" aria-label="Tablet checkout screen">
      <!-- Screen overlay area (content lives here) -->
      <div class="tablet-screen">
        <header class="pay-head">
          <div class="pay-head-left">
            <div class="pay-brand">LACE &amp; LEATHER</div>
            <div class="pay-sub">Review your cart, confirm, then scan to pay.</div>
          </div>

          <!-- =========================
               L&L PNG BUTTONS (DROP-IN SECTION)
               HEADER ACTIONS (Back left, Clear Cart right)
               ========================= -->
          <div class="pay-actions">
            <a class="ll-btn" href="./index.html" aria-label="Back">
              <img src="./L&L-buttons/back.png" alt="Back" />
            </a>

            <button class="ll-btn" id="clearCartBtn" type="button" aria-label="Clear cart">
              <img src="./L&L-buttons/clear-cart.png" alt="Clear cart" />
            </button>
          </div>
        </header>

        <!-- This is the ONLY scroll container -->
        <div class="pay-scroll" id="payScroll">
          <div class="pay-grid">
            <!-- LEFT: Cart -->
            <section class="pay-card" aria-label="Order summary">
              <h2>ORDER</h2>

              <div class="pay-row pay-row-top">
                <div>
                  <div class="pay-muted">Order ID</div>
                  <div class="pay-id"><span id="orderId">—</span></div>
                </div>

                <div class="pay-right">
                  <div class="pay-muted">Subtotal</div>
                  <div class="pay-total" id="subtotal">$0.00</div>
                </div>
              </div>

              <ul class="pay-items" id="cartList" aria-label="Cart items"></ul>

              <div class="pay-note" id="emptyNote">
                Cart is empty. Add items on the main page, then return here.
              </div>

              <!-- CONFIRM -->
              <div class="pay-confirm-wrap">
                <!-- =========================
                     CONFIRM BUTTON (PNG)
                     ========================= -->
                <button class="ll-btn" id="confirmBtn" type="button" aria-label="Confirm order">
                  <img src="./L&L-buttons/confirm-order.png" alt="Confirm order" />
                </button>

                <div class="pay-confirm-status" id="confirmStatus" aria-live="polite"></div>
              </div>

              <div class="pay-note pay-tiny" id="confirmHint">
                Confirm saves your receipt to our order log. QR appears after save.
              </div>
            </section>

            <!-- RIGHT: Pay -->
            <section class="pay-card" aria-label="Payment">
              <h2>SCAN TO PAY</h2>

              <!-- =========================
                   QR AREA (with PayPal + PAID button under QR)
                   Hidden until confirm succeeds
                   ========================= -->
              <div class="pay-qr-wrap" id="qrWrap" style="display:none;">
                <img class="pay-qr" src="./assets/lace-qr.png" alt="PayPal QR Code" />

                <a
                  class="ll-btn"
                  href="https://www.paypal.com/"
                  target="_blank"
                  rel="noopener noreferrer"
                  aria-label="Open PayPal"
                >
                  <img src="./L&L-buttons/paypal.png" alt="PayPal" />
                </a>

                <!-- ADMIN: mark paid + reset (Option B) -->
                <button class="ll-btn" id="paidBtn" type="button" aria-label="Mark paid">
                  <!-- If you don't have this PNG yet, replace with text button temporarily -->
                  <img src="./L&L-buttons/paid.png" alt="Paid" />
                </button>
              </div>

              <!-- Shown until confirm succeeds -->
              <div class="pay-qr-blocked" id="qrBlocked">
                Confirm your order to reveal the QR code.
              </div>

              <div class="pay-note">Open PayPal → Scan → Pay exact total.</div>

              <div class="pay-note pay-tiny">
                Tip: if PayPal tries to “guess” the amount, ignore it — match the total shown on the left.
                <br>
                THANK YOU!
              </div>
            </section>
          </div>
        </div>
      </div>
    </section>
  </main>

  <script>
    // =============================
    // CONFIG
    // =============================
    const ENDPOINT_URL = "https://script.google.com/macros/s/AKfycbzQSkg_6m84LsodueoI9LN6VuXhuWpfRtYNlyzleZ_I0XghmU-ra49-Bmb4SaoSG8uI/exec";

    // Storage keys
    const CART_KEY  = "ll_cart";        // array of {name, price, qty}
    const ORDER_KEY = "ll_order_id";    // string
    const LOCK_KEY  = "ll_cart_locked"; // "1" once confirmed

    // In-flight guard (prevents double-saves)
    let CONFIRM_IN_FLIGHT = false;

    // Helpers
    const $ = (id) => document.getElementById(id);

    function money(n){
      const v = Number(n || 0);
      return v.toLocaleString(undefined, { style:"currency", currency:"USD" });
    }

    function safeParse(json, fallback){
      try { return JSON.parse(json) ?? fallback; } catch { return fallback; }
    }

    function genOrderId(){
      const a = Math.random().toString(16).slice(2,6).toUpperCase();
      const b = Math.random().toString(16).slice(2,6).toUpperCase();
      return `${a}-${b}`;
    }

    function loadCart(){
      const raw = localStorage.getItem(CART_KEY);
      const cart = safeParse(raw, []);
      return Array.isArray(cart) ? cart : [];
    }

    function saveCart(cart){
      localStorage.setItem(CART_KEY, JSON.stringify(cart));
    }

    function loadOrderId(){
      let id = localStorage.getItem(ORDER_KEY);
      if(!id){
        id = genOrderId();
        localStorage.setItem(ORDER_KEY, id);
      }
      return id;
    }

    function newOrderId(){
      const id = genOrderId();
      localStorage.setItem(ORDER_KEY, id);
      return id;
    }

    function setCartLocked(v){
      localStorage.setItem(LOCK_KEY, v ? "1" : "0");
    }

    function isCartLocked(){
      return localStorage.getItem(LOCK_KEY) === "1";
    }

    function calcSubtotal(cart){
      let subtotal = 0;
      for(const item of cart){
        const qty  = Math.max(1, Number(item?.qty ?? 1));
        const price = Number(item?.price ?? 0);
        subtotal += (price * qty);
      }
      return subtotal;
    }

    // =============================
    // UI state: QR hidden until confirm succeeds
    // =============================
    function setQrReady(isReady){
      document.body.classList.toggle("qr-ready", !!isReady);
      $("qrBlocked").style.display = isReady ? "none" : "block";
      $("qrWrap").style.display = isReady ? "flex" : "none";

      // prevent wiping after confirm
      $("clearCartBtn").disabled = !!isReady;
    }

    function setConfirmStatus(msg, kind){
      const el = $("confirmStatus");
      el.textContent = msg || "";
      el.classList.remove("ok","bad");
      if(kind) el.classList.add(kind);
    }

    function setConfirmBusy(busy){
      $("confirmBtn").disabled = !!busy;
      $("confirmBtn").classList.toggle("busy", !!busy);
      $("paidBtn").disabled = !!busy;
      $("clearCartBtn").disabled = !!busy || document.body.classList.contains("qr-ready");
    }

    // =============================
    // Render
    // =============================
    function render(){
      const cart = loadCart();
      const list = $("cartList");
      const emptyNote = $("emptyNote");
      list.innerHTML = "";

      const subtotal = calcSubtotal(cart);
      $("subtotal").textContent = money(subtotal);

      const hasItems = cart.length > 0;
      emptyNote.style.display = hasItems ? "none" : "block";

      $("orderId").textContent = loadOrderId();

      // If already confirmed (locked), show QR + status
      if (isCartLocked() && hasItems) {
        setQrReady(true);
        setConfirmStatus("Saved. Scan to pay.", "ok");
      }

      if(hasItems){
        for(const item of cart){
          const name = String(item?.name ?? "Item");
          const qty  = Math.max(1, Number(item?.qty ?? 1));
          const price = Number(item?.price ?? 0);

          const li = document.createElement("li");
          li.className = "pay-item";
          li.innerHTML = `
            <div class="pay-item-name">${name}</div>
            <div class="pay-item-meta">
              <span class="pay-item-qty">x${qty}</span>
              <span class="pay-item-price">${money(price * qty)}</span>
            </div>
          `;
          list.appendChild(li);
        }
      }

      if(!hasItems){
        setCartLocked(false);
        setQrReady(false);
        setConfirmStatus("", null);
        setConfirmBusy(false);
      }
    }

    // =============================
    // POST receipt to Google Sheet
    // IMPORTANT: Use form POST (payload=<json>) to avoid CORS preflight.
    // =============================
    async function postReceipt(){
      if (CONFIRM_IN_FLIGHT) return;
      CONFIRM_IN_FLIGHT = true;

      const cart = loadCart();
      if(!cart.length){
        setConfirmStatus("Cart is empty.", "bad");
        CONFIRM_IN_FLIGHT = false;
        return;
      }

      // If already confirmed, don't resave
      if (document.body.classList.contains("qr-ready") || isCartLocked()) {
        setConfirmStatus("Already saved. Scan to pay.", "ok");
        CONFIRM_IN_FLIGHT = false;
        return;
      }

      const orderId = loadOrderId();
      const subtotal = calcSubtotal(cart);

      const items = cart.map(it => ({
        name: String(it?.name ?? "Item"),
        qty: Math.max(1, Number(it?.qty ?? 1)),
        price: Number(Number(it?.price ?? 0).toFixed(2))
      }));

      const payload = {
        order_id: orderId,
        total: Number(subtotal.toFixed(2)),
        currency: "USD",
        items,
        customer: { name: "", email: "" },
        note: "",
        referrer: document.referrer || "",
        status: "new"
      };

      setConfirmBusy(true);
      setConfirmStatus("Saving receipt…", null);

      try{
        const body = new URLSearchParams();
        body.set("payload", JSON.stringify(payload));

        const res = await fetch(ENDPOINT_URL, {
          method: "POST",
          body: body
        });

        const data = await res.json().catch(() => null);

        if(!res.ok || !data || data.ok !== true){
          setConfirmStatus("Save failed. Try again.", "bad");
          setConfirmBusy(false);
          CONFIRM_IN_FLIGHT = false;
          return;
        }

        setCartLocked(true);

        setConfirmStatus("Saved. Scan to pay.", "ok");
        setQrReady(true);
        setConfirmBusy(false);
        CONFIRM_IN_FLIGHT = false;

      }catch(err){
        setConfirmStatus("Network error. Try again.", "bad");
        setConfirmBusy(false);
        CONFIRM_IN_FLIGHT = false;
      }
    }

    // =============================
    // MARK PAID (Option B): update existing row in Sheets
    // then reset local state for next order
    // =============================
    async function markPaidAndReset(){
      if (!document.body.classList.contains("qr-ready") || !isCartLocked()) {
        setConfirmStatus("Confirm first.", "bad");
        return;
      }

      const orderId = loadOrderId();
      setConfirmBusy(true);
      setConfirmStatus("Marking paid…", null);

      try{
        const body = new URLSearchParams();
        body.set("action", "paid");
        body.set("order_id", orderId);
        body.set("paid_at", new Date().toISOString());

        const res = await fetch(ENDPOINT_URL, {
          method: "POST",
          body: body
        });

        const data = await res.json().catch(() => null);

        if(!res.ok || !data || data.ok !== true){
          setConfirmStatus("Paid update failed.", "bad");
          setConfirmBusy(false);
          return;
        }

        // Reset for next customer/order
        setCartLocked(false);
        saveCart([]);
        newOrderId();

        setQrReady(false);
        setConfirmStatus("Paid. Ready for next order.", "ok");
        setConfirmBusy(false);

        render();
        $("payScroll").scrollTo({ top: 0, behavior: "smooth" });

      }catch(err){
        setConfirmStatus("Network error (paid).", "bad");
        setConfirmBusy(false);
      }
    }

    // =============================
    // Events
    // =============================
    $("clearCartBtn").addEventListener("click", () => {
      if (isCartLocked() || document.body.classList.contains("qr-ready")) {
        setConfirmStatus("Order is locked after save. Use PAID to reset.", "bad");
        return;
      }

      saveCart([]);
      newOrderId();
      setCartLocked(false);
      setQrReady(false);
      setConfirmStatus("", null);
      setConfirmBusy(false);
      render();
      $("payScroll").scrollTo({ top: 0, behavior: "smooth" });
    });

    $("confirmBtn").addEventListener("click", () => {
      if(document.body.classList.contains("qr-ready") || isCartLocked()){
        setConfirmStatus("Already saved. Scan to pay.", "ok");
        return;
      }
      postReceipt();
    });

    $("paidBtn").addEventListener("click", () => {
      markPaidAndReset();
    });

    // Boot
    setQrReady(false);

    // If cart was previously locked, show QR immediately on load
    if (isCartLocked()) setQrReady(true);

    render();

    window.addEventListener("storage", (e) => {
      if(e.key === CART_KEY || e.key === ORDER_KEY || e.key === LOCK_KEY) render();
    });
  </script>
</body>
</html>