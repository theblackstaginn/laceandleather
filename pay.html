<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />

  <title>Cart + QR Checkout | Lace & Leather</title>
  <meta name="description" content="Tablet checkout screen for Lace & Leather. Review cart and scan QR to pay." />
  <meta name="theme-color" content="#0b0f14" />

  <link rel="icon" href="./favicon.png" />
  <link rel="apple-touch-icon" href="./icon-192.png" />
  <link rel="stylesheet" href="./styles.css" />
</head>

<body class="pay-page">
  <!-- Full-viewport stage -->
  <main class="pay-stage" aria-label="Checkout">
    <!-- Tablet “image as background” so it always fits viewport -->
    <section class="pay-tablet" aria-label="Tablet checkout frame">
      <!-- This is the “screen cutout” inside the tablet -->
      <div class="pay-screen" role="region" aria-label="Tablet screen area">
        <!-- Header INSIDE the tablet screen -->
        <header class="pay-header">
          <div class="pay-brand">
            <div class="pay-brand-title">LACE &amp; LEATHER</div>
            <div class="pay-brand-sub">Cart + QR checkout (PayPal)</div>
          </div>

          <div class="pay-header-actions">
            <a class="pay-pill" href="./index.html" aria-label="Back to front porch">Back</a>
            <button class="pay-pill" type="button" id="clearCartBtn">Clear cart</button>
          </div>
        </header>

        <!-- SCROLLABLE CONTENT (scrollbar stays INSIDE the tablet screen) -->
        <div class="pay-scroll" id="payScroll">
          <div class="pay-grid">
            <!-- LEFT: cart -->
            <section class="pay-card" aria-label="Cart">
              <h2 class="pay-h2">Cart</h2>

              <div class="pay-cart" id="cartList"></div>

              <div class="pay-row pay-total-row" aria-label="Subtotal">
                <span class="pay-muted">Subtotal</span>
                <span class="pay-money" id="subtotal">$0.00</span>
              </div>

              <div class="pay-row pay-order-row" aria-label="Order ID">
                <span class="pay-muted">Order ID</span>
                <span class="pay-order">
                  <span class="pay-order-id" id="orderId">—</span>
                  <button class="pay-mini" type="button" id="copyOrderBtn">Copy</button>
                </span>
              </div>

              <div class="pay-note">
                If you need it: your PayPal.me handle can be set inside <code>pay.html</code>.
              </div>
            </section>

            <!-- RIGHT: QR -->
            <section class="pay-card pay-qr-card" aria-label="Scan to Pay">
              <div class="pay-qr-top">
                <div class="pay-muted pay-qr-label">SCAN TO PAY</div>
                <div class="pay-amount" id="totalBig">$0.00</div>
              </div>

              <!-- Use your uploaded asset -->
              <div class="pay-qr-wrap" aria-label="QR code">
                <img
                  class="pay-qr"
                  src="./assets/lace-qr.png"
                  alt="PayPal QR code"
                  loading="eager"
                />
              </div>

              <div class="pay-actions">
                <button class="pay-cta" type="button" id="openPaypalBtn">Open PayPal</button>
                <button class="pay-ghost" type="button" id="paidBtn">I paid</button>
              </div>

              <div class="pay-fine">
                This page replaces your cart modal. Review items, then scan/pay.
              </div>
            </section>
          </div>
        </div>
      </div>
    </section>
  </main>

  <script>
    (() => {
      "use strict";

      // ====== STORAGE KEYS ======
      const CART_KEY  = "ll_cart";
      const ORDER_KEY = "ll_order_id";

      // ====== CONFIG ======
      // If you want a PayPal.me fallback button:
      // Put your PayPal.me handle here (no @). Example: "laceleather65"
      const PAYPAL_ME_HANDLE = ""; // optional

      // ====== HELPERS ======
      const money = (n) => {
        const v = Number(n || 0);
        return v.toLocaleString(undefined, { style:"currency", currency:"USD" });
      };

      const safeId = () =>
        Math.random().toString(16).slice(2, 6).toUpperCase() + "-" +
        Math.random().toString(16).slice(2, 6).toUpperCase();

      const readCart = () => {
        try {
          const raw = localStorage.getItem(CART_KEY);
          const arr = raw ? JSON.parse(raw) : [];
          return Array.isArray(arr) ? arr : [];
        } catch { return []; }
      };

      const writeCart = (arr) => {
        localStorage.setItem(CART_KEY, JSON.stringify(arr || []));
      };

      const ensureOrderId = () => {
        let id = localStorage.getItem(ORDER_KEY);
        if (!id || id === "—") {
          id = safeId();
          localStorage.setItem(ORDER_KEY, id);
        }
        return id;
      };

      // ====== RENDER ======
      const cartList = document.getElementById("cartList");
      const subtotalEl = document.getElementById("subtotal");
      const totalBigEl = document.getElementById("totalBig");
      const orderIdEl = document.getElementById("orderId");

      const normalizeItem = (it) => {
        // Accept a few shapes without breaking:
        // {name, price, qty} OR {title, amount, quantity} OR strings
        if (typeof it === "string") return { name: it, price: 0, qty: 1 };
        const name = it.name ?? it.title ?? "Item";
        const price = Number(it.price ?? it.amount ?? 0);
        const qty = Number(it.qty ?? it.quantity ?? 1);
        return { name, price, qty: Math.max(1, qty) };
      };

      const calcSubtotal = (items) =>
        items.reduce((sum, it) => sum + (Number(it.price || 0) * Number(it.qty || 1)), 0);

      const render = () => {
        const raw = readCart();
        const items = raw.map(normalizeItem);

        const orderId = ensureOrderId();
        orderIdEl.textContent = orderId;

        if (!items.length) {
          cartList.innerHTML = `<div class="pay-empty">Cart is empty.</div>`;
          subtotalEl.textContent = money(0);
          totalBigEl.textContent = money(0);
          return;
        }

        const sub = calcSubtotal(items);
        subtotalEl.textContent = money(sub);
        totalBigEl.textContent = money(sub);

        cartList.innerHTML = items.map((it) => {
          const line = it.price ? `${money(it.price)} × ${it.qty}` : `× ${it.qty}`;
          return `
            <div class="pay-line">
              <div class="pay-line-name">${escapeHtml(it.name)}</div>
              <div class="pay-line-meta">${escapeHtml(line)}</div>
            </div>
          `;
        }).join("");
      };

      const escapeHtml = (s) =>
        String(s).replace(/[&<>"']/g, (c) => ({
          "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
        }[c]));

      // ====== ACTIONS ======
      document.getElementById("copyOrderBtn")?.addEventListener("click", async () => {
        const id = orderIdEl.textContent || "";
        try {
          await navigator.clipboard.writeText(id);
          flash(orderIdEl, "Copied");
        } catch {
          // Fallback: select text
          const r = document.createRange();
          r.selectNodeContents(orderIdEl);
          const sel = window.getSelection();
          sel.removeAllRanges();
          sel.addRange(r);
          flash(orderIdEl, "Select & copy");
        }
      });

      document.getElementById("clearCartBtn")?.addEventListener("click", () => {
        writeCart([]);
        render();
      });

      document.getElementById("openPaypalBtn")?.addEventListener("click", () => {
        // Best-effort: open PayPal.me if you set handle, otherwise do nothing.
        if (!PAYPAL_ME_HANDLE) {
          alert("Set PAYPAL_ME_HANDLE in pay.html if you want this button to open PayPal.me.");
          return;
        }
        const url = `https://www.paypal.com/paypalme/${encodeURIComponent(PAYPAL_ME_HANDLE)}`;
        window.open(url, "_blank", "noopener,noreferrer");
      });

      document.getElementById("paidBtn")?.addEventListener("click", () => {
        // You can change this behavior later (e.g., keep history).
        // For now: clear cart after payment confirmation.
        writeCart([]);
        render();
        alert("Got it. Cart cleared.");
      });

      const flash = (el, text) => {
        if (!el) return;
        const prev = el.textContent;
        el.textContent = text;
        setTimeout(() => { el.textContent = prev; }, 700);
      };

      // boot
      render();
    })();
  </script>
</body>
</html>