<!doctype html>
<html lang="en" class="pay-html">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Lace & Leather — Pay</title>

  <!-- IMPORTANT: cache-bust this whenever you edit CSS -->
  <link rel="stylesheet" href="./styles.css?v=PAY-001" />
</head>

<body class="pay-page">
  <main class="pay-shell" aria-label="Checkout">
    <section class="tablet-wrap" aria-label="Tablet checkout screen">
      <!-- Tablet background image -->
      <img class="tablet-img tablet-desktop" src="./assets/tablet-web.png" alt="" aria-hidden="true" />

      <!-- Screen overlay area (content lives here) -->
      <div class="tablet-screen">
        <header class="pay-head">
          <div class="pay-head-left">
            <div class="pay-brand">LACE &amp; LEATHER</div>
            <div class="pay-sub">Review your cart, then scan to pay.</div>
          </div>

          <div class="pay-actions">
            <a class="pay-btn" href="./index.html">Back</a>
            <button class="pay-btn" id="clearCartBtn" type="button">Clear cart</button>
          </div>
        </header>

        <!-- This is the ONLY scroll container -->
        <div class="pay-scroll" id="payScroll">
          <div class="pay-grid">
            <!-- LEFT: Cart -->
            <section class="pay-card" aria-label="Order summary">
              <h2>ORDER</h2>

              <div class="pay-row pay-row-top">
                <div>
                  <div class="pay-muted">Order ID</div>
                  <div class="pay-id">
                    <span id="orderId">—</span>
                    <button class="pay-mini" id="copyOrderIdBtn" type="button">Copy</button>
                  </div>
                </div>

                <div class="pay-right">
                  <div class="pay-muted">Subtotal</div>
                  <div class="pay-total" id="subtotal">$0.00</div>
                </div>
              </div>

              <ul class="pay-items" id="cartList" aria-label="Cart items"></ul>

              <div class="pay-note" id="emptyNote">
                Cart is empty. Add items on the main page, then return here.
              </div>
            </section>

            <!-- RIGHT: Pay -->
            <section class="pay-card" aria-label="Payment">
              <h2>SCAN TO PAY</h2>

              <div class="pay-qr-wrap" id="qrWrap">
                <!-- replace path with your actual QR file -->
                <img class="pay-qr" src="./assets/lace-qr.png" alt="PayPal QR Code" />
              </div>

              <div class="pay-note">
                Open PayPal → Scan → Pay exact total.
              </div>

              <div class="pay-note pay-tiny">
                Tip: if PayPal tries to “guess” the amount, ignore it — match the total shown on the left.
                <br>
                THANK YOU!
              </div>
            </section>
          </div>
        </div>
      </div>
    </section>
  </main>

  <script>
    // ---------- Storage keys ----------
    const CART_KEY = "ll_cart";        // array of {name, price, qty}
    const ORDER_KEY = "ll_order_id";   // string

    // ---------- Helpers ----------
    const $ = (id) => document.getElementById(id);

    function money(n){
      const v = Number(n || 0);
      return v.toLocaleString(undefined, { style:"currency", currency:"USD" });
    }

    function safeParse(json, fallback){
      try { return JSON.parse(json) ?? fallback; } catch { return fallback; }
    }

    function genOrderId(){
      // short + readable
      const a = Math.random().toString(16).slice(2,6).toUpperCase();
      const b = Math.random().toString(16).slice(2,6).toUpperCase();
      return `${a}-${b}`;
    }

    function loadCart(){
      const raw = localStorage.getItem(CART_KEY);
      const cart = safeParse(raw, []);
      return Array.isArray(cart) ? cart : [];
    }

    function saveCart(cart){
      localStorage.setItem(CART_KEY, JSON.stringify(cart));
    }

    function loadOrderId(){
      let id = localStorage.getItem(ORDER_KEY);
      if(!id){
        id = genOrderId();
        localStorage.setItem(ORDER_KEY, id);
      }
      return id;
    }

    function clearOrderId(){
      const id = genOrderId();
      localStorage.setItem(ORDER_KEY, id);
      return id;
    }

    // ---------- Render ----------
    function render(){
      const cart = loadCart();
      const list = $("cartList");
      const emptyNote = $("emptyNote");
      list.innerHTML = "";

      let subtotal = 0;

      for(const item of cart){
        const name = (item?.name ?? "Item").toString();
        const qty  = Math.max(1, Number(item?.qty ?? 1));
        const price = Number(item?.price ?? 0);

        subtotal += (price * qty);

        const li = document.createElement("li");
        li.className = "pay-item";
        li.innerHTML = `
          <div class="pay-item-left">
            <div class="pay-item-name">${escapeHtml(name)}</div>
          </div>
          <div class="pay-item-meta">
            <span class="pay-item-qty">x${qty}</span>
            <span class="pay-item-price">${money(price * qty)}</span>
          </div>
        `;
        list.appendChild(li);
      }

      $("subtotal").textContent = money(subtotal);

      const hasItems = cart.length > 0;
      emptyNote.style.display = hasItems ? "none" : "block";

      // Ensure order id exists
      $("orderId").textContent = loadOrderId();
    }

    function escapeHtml(str){
      return str
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    // ---------- Events ----------
    $("clearCartBtn").addEventListener("click", () => {
      saveCart([]);
      clearOrderId();  // fresh order id after wipe
      render();
      // scroll to top of in-screen area so it "feels" responsive
      $("payScroll").scrollTo({ top: 0, behavior: "smooth" });
    });

    $("copyOrderIdBtn").addEventListener("click", async () => {
      const id = $("orderId").textContent.trim();
      try{
        await navigator.clipboard.writeText(id);
        $("copyOrderIdBtn").textContent = "Copied";
        setTimeout(() => $("copyOrderIdBtn").textContent = "Copy", 900);
      }catch{
        // fallback: do nothing
      }
    });

    // ---------- Boot ----------
    render();
    window.addEventListener("storage", (e) => {
      if(e.key === CART_KEY || e.key === ORDER_KEY) render();
    });
  </script>
</body>
</html>
